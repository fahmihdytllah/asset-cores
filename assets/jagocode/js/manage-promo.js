$(function(){let e=$(".datatables-basic"),t=$("#formPromo"),n,a="0",o="new";firebase.initializeApp({apiKey:"AIzaSyClXd1AAB_Nzlm52X4GB7V9TR0Rv8YCu1w",authDomain:"jago-code.firebaseapp.com",projectId:"jago-code",storageBucket:"jago-code.appspot.com",messagingSenderId:"733341114140",appId:"1:733341114140:web:aee7d8fd24e979e9bba4d9",measurementId:"G-4CDRVEBPJD"});let r=firebase.storage(),s=$("#validFrom").flatpickr({enableTime:!0,dateFormat:"Y-m-d H:i"}),i=$("#validUntil").flatpickr({enableTime:!0,dateFormat:"Y-m-d H:i"});$("#inputBanner").change(function(t){t=t.target.files[0];if(t&&t.type.startsWith("image/")){var a=new FileReader;let e=r.ref().child("banners/"+t.name).put(t);a.onload=function(e){$("#previewBanner").attr("src",e.target.result).show()},a.readAsDataURL(t),e.on("state_changed",e=>{e=e.bytesTransferred/e.totalBytes*100;console.log("Upload progress: "+e+"%")},e=>{console.error("Error uploading file: ",e)},()=>{e.snapshot.ref.getDownloadURL().then(e=>{$("#banner").val(e)})})}else $("#previewBanner").hide()}),e.length&&(n=e.DataTable({ajax:{url:"?type=json",type:"GET",beforeSend:function(){$(".card").block({message:elementLoader,css:{backgroundColor:"transparent",border:"0"},overlayCSS:{backgroundColor:"#fff",opacity:.8}})},complete:function(){$(".card").unblock()}},columns:[{data:"_id"},{data:"title"},{data:"description"},{data:"code"},{data:"isActive"},{data:"validFrom"},{data:"validUntil"},{data:""}],columnDefs:[{className:"control",orderable:!1,searchable:!1,responsivePriority:2,targets:0,render:function(e,t,a,n){return""}},{responsivePriority:1,targets:1,render:function(e,t,a,n){return'<div class="d-flex justify-content-start align-items-center "><img src="'+(a?.banner||"https://ui-avatars.com/api/?background=random&name="+a.title)+'" alt="'+a.title+'" class="rounded me-2 w-px-100"><div class="d-flex flex-column"><h6 class="text-nowrap mb-0">'+a.title+'</h6><small class="text-truncate d-none d-sm-block">Discount <strong>'+a.discountPercentage+"%</strong>"}},{targets:4,render:function(e,t,a,n){return'<span class="badge '+(a.isActive?"bg-label-success":"bg-label-danger")+'" text-capitalized>'+(a.isActive?"Active":"Non Active")+"</span>"}},{targets:-3,render:function(e,t,a,n){return new Date(a.validFrom).toLocaleString("en-US",{year:"numeric",month:"long",day:"numeric"})}},{targets:-2,render:function(e,t,a,n){return new Date(a.validUntil).toLocaleString("en-US",{year:"numeric",month:"long",day:"numeric"})}},{targets:-1,title:"Actions",orderable:!1,searchable:!1,render:function(e,t,a,n){return'<div class="d-inline-block text-nowrap"><button class="btn btn-sm btn-edit btn-icon btn-text-secondary rounded-pill waves-effect waves-light" data-id="'+a._id+'"><i class="ti ti-edit ti-md"></i></button><button class="btn btn-sm btn-delete btn-icon btn-text-secondary rounded-pill waves-effect waves-light" data-id="'+a._id+'"><i class="ti ti-trash ti-md"></i></button></div>'}}],dom:'<"card-header flex-column flex-md-row"<"head-label text-center"><"dt-action-buttons text-end pt-3 pt-md-0"B>><"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6 d-flex justify-content-center justify-content-md-end"f>>t<"row"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6"p>>',displayLength:7,lengthMenu:[7,10,25,50,75,100],buttons:[{text:'<i class="ti ti-plus me-sm-1"></i> <span class="d-none d-sm-inline-block">New Promo</span>',className:"create-new btn btn-primary waves-effect waves-light",action:function(){a="0",o="new",$("#modalPromo").modal("show")}}],responsive:{details:{display:$.fn.dataTable.Responsive.display.modal({header:function(e){e.data();return"Promo Details"}}),type:"column",renderer:function(e,t,a){a=$.map(a,function(e,t){return""!==e.title?'<tr data-dt-row="'+e.rowIndex+'" data-dt-column="'+e.columnIndex+'"><td>'+e.title+":</td> <td>"+e.data+"</td></tr>":""}).join("");return!!a&&$('<table class="table"/><tbody />').append(a)}}}}),$("div.head-label").html('<h5 class="card-title mb-0">Manage Promo</h5>')),t.submit(function(e){e.preventDefault(),t.block({message:elementLoader,css:{backgroundColor:"transparent",border:"0"},overlayCSS:{backgroundColor:"#fff",opacity:.8}}),$.ajax({data:t.serialize(),url:"?id="+a,type:"new"===o?"POST":"PUT",success:function(e){t.unblock(),t[0].reset(),n.ajax.reload(),$("#modalPromo").modal("hide"),Swal.fire({title:"Good job!",text:e.msg,icon:"success",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1})},error:function(e){t.unblock();e=e.responseJSON?.msg;Swal.fire({title:"Upss!",text:e||"There is an error!",icon:"error",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1})}})}),$(".datatables-basic tbody").on("click",".btn-edit",function(){var e=$(this).data("id");a=e,o="edit",$.get("?type=detail&id="+e,function(e){$("#previewBanner").attr("src",e.banner),$("#banner").val(e.banner),$("#title").val(e.title),$("#description").val(e.description),$("#code").val(e.code),$("#discountPercentage").val(e.discountPercentage),$("#maxUsage").val(e.maxUsage),s.setDate(e.validFrom),i.setDate(e.validUntil),e.isActive?$("#isActive").prop("checked",!0):$("#isActive").prop("checked",!1),$("#modalPromo").modal("show")})}),$(".datatables-basic tbody").on("click",".btn-delete",function(){let t=$(this),a=t.data("id");Swal.fire({title:"Are you sure?",text:"Do you want to delete this promo!",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, delete it!",customClass:{confirmButton:"btn btn-primary me-3 waves-effect waves-light",cancelButton:"btn btn-label-secondary waves-effect waves-light"},buttonsStyling:!1}).then(function(e){e.value&&($.blockUI({message:elementLoader,css:{backgroundColor:"transparent",border:"0"},overlayCSS:{backgroundColor:"#fff",opacity:.8}}),$.ajax({url:"?id="+a,type:"DELETE",success:function(e){$.unblockUI(),n.row(t.parents("tr")).remove().draw(),Swal.fire({title:"Good job!",text:e.msg,icon:"success",customClass:{confirmButton:"btn btn-success waves-effect waves-light"}})},error:function(e){$.unblockUI();e=e.responseJSON.msg;Swal.fire({title:"Upss!",text:e||"There is an error!",icon:"error",customClass:{confirmButton:"btn btn-primary"}})}}))})}),setTimeout(()=>{$(".dataTables_filter .form-control").removeClass("form-control-sm"),$(".dataTables_length .form-select").removeClass("form-select-sm")},300)});