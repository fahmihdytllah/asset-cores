$(document).ready(function(){let t=$(".select2"),a=$("#listWorkers"),e=$("#formUpdate"),s=io("/socket/users"),o=[],i={},r={},n={},l=null;function d(t){a.html(""),$("#loadingWorkers").hide(),0===t?.length?a.html(`<div class="col-md-12">
          <div class="bg-lighter rounded p-3 mb-3 position-relative">
            <span class="text-muted">Oops, it seems the worker was not found...
          </div>
        </div>`):(t.forEach(t=>{a.append(c(t))}),$('[data-bs-toggle="popover"]').popover())}function c(t){return f(t),`<div class="col-12 col-md-6 col-lg-4 col-xxl-3 mb-3" id="worker-${t._id}">
      <div class="card worker-card h-100">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex justify-content-left align-items-center mb-1">
            <i class="fis fi fi-xs fi-${t.countryCode.toLowerCase()} rounded-circle fs-1 me-3"></i>

            <div class="d-flex flex-column">
              <span class="fw-medium">${t.ip}</span>
              <div class="d-flex align-items-center worker-status">
                ${u(t)}
              </div>
            </div>
          </div>

          <div class="d-flex align-items-center">
            <span class="worker-stop me-2" data-id="${t._id}">${m(t)}</span>
            <span class="worker-description me-2" data-bs-toggle="popover" data-bs-placement="top" data-bs-content="${t?.description||"-"}"><i class="ti ti-info-circle ti-sm text-info"></i></span>

            <div class="dropdown dropend">
              <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown" data-bs-container="body" aria-expanded="false">
                <i class="ti ti-dots-vertical"></i>
              </button>
              <div class="dropdown-menu">
                <button class="dropdown-item worker-update" data-id="${t._id}"><i class="ti ti-edit me-1"></i> Edit</button>
                <hr class="dropdown-divider">
                <button class="dropdown-item worker-logs" data-id="${t._id}"><i class="ti ti-terminal-2 me-1"></i> Realtime Logs</button>
                <button class="dropdown-item worker-restart" data-id="${t._id}"><i class="ti ti-rotate me-1"></i> Restart Worker</button>
                <button class="dropdown-item server-reboot" data-id="${t._id}"><i class="ti ti-server-2 me-1"></i> Reboot Server</button>
                <hr class="dropdown-divider">
                <button class="dropdown-item worker-delete text-danger" data-id="${t._id}"><i class="ti ti-trash me-1"></i> Delete</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="collapse mt-3 ${i[t._id]?"":"show"}" id="detail-${t._id}">
          <ul class="list-unstyled row">
            <div class="col-4">
              <li class="d-flex align-items-center mb-2" data-type="tooltip" data-text="CPU Usage"><i class="ti ti-cpu ti-sm text-dark"></i><span class="text-muted mx-2 cpu">${t.cpuUsage}%</span></li>
              <li class="d-flex align-items-center mb-2" data-type="tooltip" data-text="Visitors"><i class="ti ti-users ti-sm text-dark"></i><span class="text-muted mx-2 totalHitsPerDay">${t.totalHitsPerDay.toLocaleString()}</span></li>
              <li class="d-flex align-items-center mb-2" data-type="tooltip" data-text="Ad Views"><i class="ti ti-ad ti-sm text-dark"></i><span class="text-muted mx-2 totalViewAdsPerDay">${t.totalViewAdsPerDay.toLocaleString()}</span></li>
              <li class="d-flex align-items-center mb-2" data-type="tooltip" data-text="Ad Clicks"><i class="ti ti-click ti-sm text-dark"></i><span class="text-muted mx-2 totalClickAdsPerDay">${t.totalClickAdsPerDay.toLocaleString()}</span></li>
              <li class="d-flex align-items-center" data-type="tooltip" data-text="Errors"><i class="ti ti-exclamation-circle ti-sm text-dark"></i><span class="text-muted mx-2 totalErrorPerDay">${t.totalErrorPerDay.toLocaleString()}</span></li>
            </div>
            <div class="col-8">
              <li class="d-flex align-items-center mb-2" data-type="tooltip" data-text="Memory Usage"><i class="ti ti-server ti-sm text-dark"></i><span class="text-muted mx-2 memory">${t.memoryUsage}%</span></li>
              <li class="d-flex align-items-center mb-2" data-type="tooltip" data-text="Access Key"><i class="ti ti-key ti-sm text-dark"></i><span class="text-muted mx-2 key">${t.keyName}</span></li>
              <li class="d-flex align-items-center mb-2" data-type="tooltip" data-text="Uptime"><i class="ti ti-clock ti-sm text-dark"></i><span class="text-muted mx-2 uptime">${w(t.uptime)}</span></li>
              <li class="d-flex align-items-center mb-2" data-type="tooltip" data-text="Last Activity"><i class="ti ti-activity ti-sm text-dark"></i><span class="text-muted mx-2 lastActivity">${moment(t.lastActivity).fromNow()}</span></li>
              <li class="d-flex align-items-center" data-type="tooltip" data-text="Network"><i class="ti ti-network ti-sm text-dark"></i><span class="text-muted mx-2 network">${t.network}</span></li>
            </div>
          </ul>
        </div>
      </div>
    </div>`}function m(t){return t.isStarted?'<i class="ti ti-player-pause ti-sm text-danger"></i>':'<i class="ti ti-player-play ti-sm text-success"></i>'}function u(t){return t.isActive?' <span class="blinking badge badge-dot bg-success me-1"></span><small class="text-muted">online</small>':'<span class="badge badge-dot bg-danger me-1"></span><small class="text-muted">offline</small>'}function p(a,t,s){let o=50*Math.abs(s-t),r=performance.now();requestAnimationFrame(function t(e){var e=e-r,e=Math.min(e/o,1),i=Math.floor(e*s);a.text(i.toLocaleString()),e<1&&requestAnimationFrame(t)})}function f(i){i.isActive?(void 0===n[i._id]&&(n[i._id]=parseFloat(i.uptime)),void 0!==r[i._id]&&clearInterval(r[i._id]),r[i._id]=setInterval(function(){var t,e;t=i,n[t._id]+=1,(e=$("#worker-"+t._id)).find(".uptime").text(w(n[t._id])),e.find(".lastActivity").html(moment(t.lastActivity).fromNow())},1e3)):void 0!==r[i._id]&&clearInterval(r[i._id])}function w(t){return Math.floor(t/3600)+`h ${Math.floor(t%3600/60)}m ${Math.floor(t%60)}s`}t.length&&t.each(function(){var t=$(this);t.wrap('<div class="position-relative"></div>').select2({placeholder:"Select value",dropdownParent:t.parent()})}),$("#loadingWorkers").show(),$.get("?type=json",function(t){$("#loadingWorkers").hide(),d(o=t.data);var e,t=(t=>{let e={};return t.forEach(function(t){e[t.keyName]?e[t.keyName]++:e[t.keyName]=1}),e})(o),i=$("#byKey"),a=Object.fromEntries(Object.entries(t).sort(([t],[e])=>t.localeCompare(e)));for(e in a)i.append('<option value="'+e+'" data-type="byKey">'+e+" ("+a[e]+") </option>")}),setTimeout(()=>{s.emit("request-system-usage",userId)},5e3),s.on("connect",()=>{s.emit("join",userId)}),s.on("worker-connected",e=>{var t=o?.find(t=>t._id===e._id);t?(t.isActive||toastr.success("Worker "+e.ip+" is active again","Worker is active again!"),t=$("#worker-"+e._id),a.prepend(t),t.find(".worker-status").html(u(e)),t.find(".worker-stop").html(m(e))):(o.push(e),a.prepend(c(e)),toastr.success("New workers have been added: "+e.ip,"New worker added!"))}),s.on("stopped-worker",e=>{var t=o?.findIndex(t=>t._id===e._id);-1!==t&&(o[t]={...o[t],...e},$("#worker-"+e._id).find(".worker-stop").html(m(e)))}),s.on("updated-worker",e=>{var t,i=o?.findIndex(t=>t._id===e._id);-1!==i&&(t=o[i],o[i]={...o[i],...e},i=$("#worker-"+e._id))&&(e.isActive?(p(i.find(".totalHitsPerDay"),t.totalHitsPerDay,e.totalHitsPerDay),p(i.find(".totalClickAdsPerDay"),t.totalClickAdsPerDay,e.totalClickAdsPerDay),p(i.find(".totalViewAdsPerDay"),t.totalViewAdsPerDay,e.totalViewAdsPerDay),p(i.find(".totalErrorPerDay"),t.totalErrorPerDay,e.totalErrorPerDay),i.find(".lastActivity").html(moment(e.lastActivity).fromNow())):(a.append(i),toastr.warning("Worker "+e.ip+" is currently inactive","Worker not active!")),i.find(".worker-status").html(u(e)),i.find(".worker-stop").html(m(e)),f(e))}),s.on("response-system-usage",e=>{var t=o?.findIndex(t=>t._id===e._id);-1!==t&&(o[t]={...o[t],...e},t=$("#worker-"+e._id))&&(t.find(".cpu").text(e.cpuUsage+"%"),t.find(".memory").text(e.memoryUsage+"%"))}),s.on("response-monitor-log",({message:t})=>{t&&(t=t.replace(/\n/g,"\r\n")+"\r\n\n",l.write(t))}),s.on("message",t=>{toastr[t.type](t.message,t.title)}),$(document).on("click",".worker-logs",function(){let e=$(this).data("id");var t=o?.find(t=>t._id===e);t&&((l=new Terminal({fontSize:14,theme:{background:"#000000",foreground:"#ffffff",cursor:"green"}})).open(document.getElementById("terminal-logs")),$("#modalMonitorLog").modal("show"),$("#terminal-id").val(e),s.emit("request-monitor-log",{status:!0,data:t}))}),$("#modalMonitorLog").on("hidden.bs.modal",function(){let e=$("#terminal-id").val();var t=o?.find(t=>t._id===e);t&&(l.dispose(),s.emit("request-monitor-log",{status:!1,data:t}))}),$(document).on("click",".worker-update",function(){var t=$(this).data("id");$.get("?type=detail&id="+t,function({data:t}){$("#workerId").val(t._id),$("#accessKey").val(t.keyId),$("#description").val(t.description),$("#modalUpdateWorker").modal("show")})}),e.submit(function(t){t.preventDefault(),e.block({message:itemLoader,css:{backgroundColor:"transparent",border:"0"},overlayCSS:{backgroundColor:"#fff",opacity:.8}}),$.ajax({url:"?",data:e.serialize(),type:"PUT",success:function(t){e.unblock(),$("#modalUpdateWorker").modal("hide"),toastr.success(t.msg,"Good News!")},error:function(t){e.unblock();t=t.responseJSON?.msg;toastr.success(t,"Bad News!")}})}),$(document).on("click",".worker-stop",function(){let e=$(this).data("id"),i=o?.find(t=>t._id===e);i&&Swal.fire({title:i.isStarted?"Stop Worker":"Run Worker",text:i.isStarted?"Are you sure you want to stop this worker?":"Are you sure you want to run this worker?",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes",customClass:{confirmButton:"btn btn-primary waves-effect waves-light",cancelButton:"btn btn-outline-danger ms-2 waves-effect waves-light"},buttonsStyling:!1}).then(function(t){t.value&&s.emit("request-stopped",i)})}),$(document).on("click",".worker-restart",function(){let e=$(this).data("id");Swal.fire({title:"Restart Worker",text:"Are you sure you want to restart this worker? The worker will start automatically",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes",customClass:{confirmButton:"btn btn-primary waves-effect waves-light",cancelButton:"btn btn-outline-danger ms-2 waves-effect waves-light"},buttonsStyling:!1}).then(function(t){t.value&&(t=o?.find(t=>t._id===e))&&s.emit("request-restart",t)})}),$(document).on("click",".server-reboot",function(){let e=$(this).data("id");Swal.fire({title:"Reboot Server",text:"Are you sure you want to reboot this server worker? The worker will die and cannot start automatically",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes",customClass:{confirmButton:"btn btn-primary waves-effect waves-light",cancelButton:"btn btn-outline-danger ms-2 waves-effect waves-light"},buttonsStyling:!1}).then(function(t){t.value&&(t=o?.find(t=>t._id===e))&&s.emit("request-reboot",t)})}),$(document).on("click",".worker-delete",function(){let e=$(this).data("id");Swal.fire({title:"Remove Worker",text:"Are you sure you want to remove this worker?",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes",customClass:{confirmButton:"btn btn-primary waves-effect waves-light",cancelButton:"btn btn-outline-danger ms-2 waves-effect waves-light"},buttonsStyling:!1}).then(function(t){var i;t.value&&(i=e,$.blockUI({message:itemLoader,css:{backgroundColor:"transparent",border:"0"},overlayCSS:{backgroundColor:"#fff",opacity:.8}}),$.ajax({url:"?id="+i,type:"DELETE",success:function(t){$.unblockUI(),$("#worker-"+i).remove();var e=o.findIndex(({_id:t})=>t===i);-1!==e&&o.splice(e,1),toastr.success(t.msg,"Good News!")},error:function(t){$.unblockUI();t=t.responseJSON?.msg;toastr.success(t||"There is an error!","Good News!")}}))})}),$(document).on("click",".worker-detail",function(){var t=$(this).data("id");void 0===i[t]&&(i[t]=!1),i[t]?$(this).html('<i class="ti ti-stack-push ti-sm text-info"></i>'):$(this).html('<i class="ti ti-stack-pop ti-sm text-info"></i>'),i[t]=!i[t]}),$(".search-worker").on("input",function(){var t=$(this).val(),t=($("#loadingWorkers").show(),((t,i)=>{let a=["ip","country","network","keyName"];return t.filter(e=>a.some(t=>!(!e[t]||"string"!=typeof e[t])&&e[t].toLowerCase().includes(i.toLowerCase())))})(o,t));d(t)}),$("#filtered").change(function(){let i=$(this).val();var t=$(this).find("option:selected").data("type");let e=[];d(e="byKey"===t?o?.filter(t=>t.keyName===i):"byActive"===t?(i="online"===i,o?.filter(t=>t.isActive===i)):"byStats"===t?o?.sort(function(t,e){return e[i]-t[i]}):"byCountry"===t?o?.sort(function(t,e){t=t.country.toLowerCase(),e=e.country.toLowerCase();return t.localeCompare(e)}):(o.sort((t,e)=>t.isActive!==e.isActive?e.isActive-t.isActive:t.keyName.localeCompare(e.keyName)),o))})});